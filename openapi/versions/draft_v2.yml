openapi: 3.0.0
info:
  description: |
    > This `draft` version is intended to facilitate design and development of what will be the first release of Version 2 of the API.

    Provides an interface for calculating charges, creating and queuing transactions, and generating transaction and customer files used to produce Environment Agency invoices.

    This represents Version 2 of the API, which is based on the [sroc-charging-module-api project](https://github.com/DEFRA/sroc-charging-module-api). It is intended to supercede Version 1, which is based on the [charging-module-api project](https://github.com/DEFRA/charging-module-api)

    ## Working with the API

    The [SRoC service team](https://github.com/DEFRA/sroc-service-team) use [Postman](https://www.postman.com/) as the means to interact with the API. Check out their [docs](https://github.com/DEFRA/sroc-service-team/postman) for info on how to go about setting up your own Postman environment.
  version: draft
  title: Charging Module API V2
  contact:
    name: SROC Service Team
    email: alan.cruikshanks@environment-agency.gov.uk
    url: https://github.com/DEFRA/sroc-service-team
  license:
    name: Open Government Licence (OGL)
    url: http://www.nationalarchives.gov.uk/doc/open-government-licence/version/3
servers:
- description: Local
  url: http://localhost:3003
tags:
- name: billrun
  description: Operations related to bill runs
- name: calculate
  description: Operations related to calculating charges
- name: customer
  description: Operations related to customer files
- name: transaction
  description: Operations related to transactions
- name: suggested
  description: Operations that could be made available to client systems
- name: admin
  description: Only the admin user can access these endpoints. They are not for use
    by client systems
- name: health
  description: Endpoints used to confirm the system is up. Often used by monitoring
    tools running 'health checks'
paths:
  "/":
    get:
      operationId: Root
      description: Confirm service is up and running. Exactly the same as `/status`
      tags:
      - health
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                description: Returned by a call to status, it is an object that contains
                  a copy of the headers found in the original request
                type: object
                properties:
                  status:
                    type: string
                    example: alive
  "/status":
    get:
      operationId: Status
      description: Confirm service is up and running
      tags:
      - health
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                description: Returned by a call to status, it is an object that contains
                  a copy of the headers found in the original request
                type: object
                properties:
                  status:
                    type: string
                    example: alive
  "/admin/regimes":
    get:
      operationId: ListRegimes
      description: Request a list of the charging regimes recognised and managed by
        the service
      tags:
      - admin
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: array
                items:
                  description: Charging regime that will have its own charge rules
                  type: object
                  properties:
                    id:
                      description: Internal ID (GUID) allocated by the CM when creating
                        a regime.
                      type: string
                      format: uuid
                      example: fd2ab097-3097-42bd-849e-046aa250a0d0
                    slug:
                      type: string
                      enum:
                      - cfd
                      - pas
                      - wml
                      - wrls
                      example: wrls
                    name:
                      type: string
                      example: Water Resources
                    preSrocCutoffDate:
                      description: NOT IN MASTER DATA SPECIFICATION
                      type: string
                      format: datetime
                      example: '2020-09-11T11:56:41.578Z'
                    createdAt:
                      description: NOT IN MASTER DATA SPECIFICATION
                      type: string
                      format: datetime
                      example: '2020-09-11T11:56:41.578Z'
                    updatedAt:
                      description: NOT IN MASTER DATA SPECIFICATION
                      type: string
                      format: datetime
                      example: '2020-09-11T11:56:41.578Z'
              example:
              - id: ef5ee223-2ee5-4f02-ace5-35330d9f3781
                slug: cfd
                name: Water Quality
                preSrocCutoffDate: '2018-04-01T00:00:00.000Z'
                createdAt: '2020-12-01T09:19:22.065Z'
                updatedAt: '2020-12-01T09:19:22.065Z'
              - id: 6bd74eeb-6beb-41d9-be52-5934a49ecd97
                slug: pas
                name: Installations
                preSrocCutoffDate: '2018-04-01T00:00:00.000Z'
                createdAt: '2020-12-01T09:19:22.065Z'
                updatedAt: '2020-12-01T09:19:22.065Z'
              - id: 458834a2-0541-4981-87f6-2c0ec9261661
                slug: wml
                name: Waste
                preSrocCutoffDate: '2018-04-01T00:00:00.000Z'
                createdAt: '2020-12-01T09:19:22.065Z'
                updatedAt: '2020-12-01T09:19:22.065Z'
              - id: 2f62bc92-7372-4d2a-979b-792e530c311c
                slug: wrls
                name: Water Resources
                preSrocCutoffDate: '2020-04-01T00:00:00.000Z'
                createdAt: '2020-12-01T09:19:22.065Z'
                updatedAt: '2020-12-01T09:19:22.065Z'
  "/admin/regimes/{regimeId}":
    get:
      operationId: ViewRegime
      description: Request details of a 'regime'.
      tags:
      - admin
      parameters:
      - name: regimeId
        in: path
        required: true
        description: Internal ID (GUID) allocated by the CM when creating a regime.
        schema:
          description: Internal ID (GUID) allocated by the CM when creating a regime.
          type: string
          format: uuid
          example: fd2ab097-3097-42bd-849e-046aa250a0d0
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                description: Charging regime that will have its own charge rules
                type: object
                properties:
                  id:
                    description: Internal ID (GUID) allocated by the CM when creating
                      a regime.
                    type: string
                    format: uuid
                    example: fd2ab097-3097-42bd-849e-046aa250a0d0
                  slug:
                    type: string
                    enum:
                    - cfd
                    - pas
                    - wml
                    - wrls
                    example: wrls
                  name:
                    type: string
                    example: Water Resources
                  preSrocCutoffDate:
                    description: NOT IN MASTER DATA SPECIFICATION
                    type: string
                    format: datetime
                    example: '2020-09-11T11:56:41.578Z'
                  createdAt:
                    description: NOT IN MASTER DATA SPECIFICATION
                    type: string
                    format: datetime
                    example: '2020-09-11T11:56:41.578Z'
                  updatedAt:
                    description: NOT IN MASTER DATA SPECIFICATION
                    type: string
                    format: datetime
                    example: '2020-09-11T11:56:41.578Z'
              example:
                id: 2f62bc92-7372-4d2a-979b-792e530c311c
                slug: wrls
                name: Water Resources
                preSrocCutoffDate: '2020-04-01T00:00:00.000Z'
                createdAt: '2020-12-01T09:19:22.065Z'
                updatedAt: '2020-12-01T09:19:22.065Z'
                authorisedSystems:
                - id: b36d674f-b97c-4685-95f3-aacae8c97bde
                  clientId: 1b1gshltt176v80nsc4fxxxxxx
                  name: wrls
                  status: active
                  admin: 'false'
                  createdAt: '2020-12-02T09:19:22.065Z'
                  updatedAt: '2020-12-02T09:19:22.065Z'
  "/admin/authorised-systems":
    get:
      operationId: ListAuthorisedSystems
      description: Request a list of 'authorised systems'. An authorised system is
        essentially a user of the API, and this returns those users permitted to access
        it.
      tags:
      - admin
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  authorisedSystems:
                    type: array
                    items:
                      description: Essentially the user account of a system authorised
                        to use the API. Includes what regimes each account is authorised
                        to make requests for.
                      type: object
                      properties:
                        id:
                          description: Internal ID (GUID) allocated by the CM when
                            creating an authorised system.
                          type: string
                          format: uuid
                          example: fd2ab097-3097-42bd-849e-046aa250a0d0
                        clientId:
                          description: NOT IN MASTER DATA SPECIFICATION
                          type: string
                          example: i7rnixijjrawj7azzhwwxxxxxx
                        name:
                          type: string
                          example: wrls
                        status:
                          type: string
                          example: active
                        admin:
                          description: Boolean indicator to show whether or not the
                            authorised system is an 'admin' user of the API
                          type: boolean
                          example: false
                        createdAt:
                          description: NOT IN MASTER DATA SPECIFICATION
                          type: string
                          format: datetime
                          example: '2020-09-11T11:56:41.578Z'
                        updatedAt:
                          description: NOT IN MASTER DATA SPECIFICATION
                          type: string
                          format: datetime
                          example: '2020-09-11T11:56:41.578Z'
              example:
              - id: ac12ac4b-9b9e-4cba-a06f-a90f611a1ef1
                clientId: 710uhe3hqumsk2da43foxxxxxx
                name: admin
                status: active
                admin: 'true'
                createdAt: '2020-11-01T09:19:22.065Z'
                updatedAt: '2020-11-01T09:19:22.065Z'
              - id: b36d674f-b97c-4685-95f3-aacae8c97bde
                clientId: 1b1gshltt176v80nsc4fxxxxxx
                name: wrls
                status: active
                admin: 'false'
                createdAt: '2020-12-02T09:19:22.065Z'
                updatedAt: '2020-12-02T09:19:22.065Z'
    post:
      operationId: AddAuthorisedSystem
      description: Add a new 'authorised system'. An authorised system is essentially
        a user of the API, and this adds a new one to it.
      tags:
      - admin
      responses:
        '201':
          description: Success
          content:
            application/json:
              schema:
                description: Essentially the user account of a system authorised to
                  use the API. Includes what regimes each account is authorised to
                  make requests for.
                type: object
                properties:
                  id:
                    description: Internal ID (GUID) allocated by the CM when creating
                      an authorised system.
                    type: string
                    format: uuid
                    example: fd2ab097-3097-42bd-849e-046aa250a0d0
                  clientId:
                    description: NOT IN MASTER DATA SPECIFICATION
                    type: string
                    example: i7rnixijjrawj7azzhwwxxxxxx
                  name:
                    type: string
                    example: wrls
                  status:
                    type: string
                    example: active
                  admin:
                    description: Boolean indicator to show whether or not the authorised
                      system is an 'admin' user of the API
                    type: boolean
                    example: false
                  createdAt:
                    description: NOT IN MASTER DATA SPECIFICATION
                    type: string
                    format: datetime
                    example: '2020-09-11T11:56:41.578Z'
                  updatedAt:
                    description: NOT IN MASTER DATA SPECIFICATION
                    type: string
                    format: datetime
                    example: '2020-09-11T11:56:41.578Z'
              example:
                id: 9e76203a-e900-41a1-a045-2551d98e010c
                clientId: i7rnixijjrawj7azzhwwxxxxxx
                name: dashboard
                status: active
                admin: 'false'
                createdAt: '2020-12-04T09:19:22.065Z'
                updatedAt: '2020-12-04T09:19:22.065Z'
                regimes:
                - id: ef5ee223-2ee5-4f02-ace5-35330d9f3781
                  slug: cfd
                  name: Water Quality
                  preSrocCutoffDate: '2018-04-01T00:00:00.000Z'
                  createdAt: '2020-12-01T09:19:22.065Z'
                  updatedAt: '2020-12-01T09:19:22.065Z'
                - id: 6bd74eeb-6beb-41d9-be52-5934a49ecd97
                  slug: pas
                  name: Installations
                  preSrocCutoffDate: '2018-04-01T00:00:00.000Z'
                  createdAt: '2020-12-01T09:19:22.065Z'
                  updatedAt: '2020-12-01T09:19:22.065Z'
                - id: 458834a2-0541-4981-87f6-2c0ec9261661
                  slug: wml
                  name: Waste
                  preSrocCutoffDate: '2018-04-01T00:00:00.000Z'
                  createdAt: '2020-12-01T09:19:22.065Z'
                  updatedAt: '2020-12-01T09:19:22.065Z'
                - id: 2f62bc92-7372-4d2a-979b-792e530c311c
                  slug: wrls
                  name: Water Resources
                  preSrocCutoffDate: '2020-04-01T00:00:00.000Z'
                  createdAt: '2020-12-01T09:19:22.065Z'
                  updatedAt: '2020-12-01T09:19:22.065Z'
      requestBody:
        content:
          application/json:
            schema:
              description: Essentially the user account of a system authorised to
                use the API. Includes what authorisations each account has.
              type: object
              properties:
                clientId:
                  description: NOT IN MASTER DATA SPECIFICATION
                  type: string
                  example: i7rnixijjrawj7azzhwwxxxxxx
                name:
                  type: string
                  example: wrls
                status:
                  type: string
                  example: active
                authorisations:
                  type: array
                  items:
                    description: NOT IN MASTER DATA SPECIFICATION
                    type: string
                    enum:
                    - cfd
                    - pas
                    - wml
                    - wrls
                    example: wrls
            example:
              clientId: i7rnixijjrawj7azzhwwxxxxxx
              name: dashboard
              status: active
              authorisations:
              - cfd
              - pas
              - wml
              - wrls
  "/admin/authorised-systems/{authorisedSystemId}":
    get:
      operationId: ViewAuthorisedSystem
      description: Request details of an 'authorised system'. An authorised system
        is essentially a user of the API, and this returns details about it including
        which regimes it is authorised to access.
      tags:
      - admin
      parameters:
      - name: authorisedSystemId
        in: path
        required: true
        description: Internal ID (GUID) allocated by the CM when creating an authorised
          system.
        schema:
          description: Internal ID (GUID) allocated by the CM when creating an authorised
            system.
          type: string
          format: uuid
          example: fd2ab097-3097-42bd-849e-046aa250a0d0
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                description: Essentially the user account of a system authorised to
                  use the API. Includes what regimes each account is authorised to
                  make requests for.
                type: object
                properties:
                  id:
                    description: Internal ID (GUID) allocated by the CM when creating
                      an authorised system.
                    type: string
                    format: uuid
                    example: fd2ab097-3097-42bd-849e-046aa250a0d0
                  clientId:
                    description: NOT IN MASTER DATA SPECIFICATION
                    type: string
                    example: i7rnixijjrawj7azzhwwxxxxxx
                  name:
                    type: string
                    example: wrls
                  status:
                    type: string
                    example: active
                  admin:
                    description: Boolean indicator to show whether or not the authorised
                      system is an 'admin' user of the API
                    type: boolean
                    example: false
                  createdAt:
                    description: NOT IN MASTER DATA SPECIFICATION
                    type: string
                    format: datetime
                    example: '2020-09-11T11:56:41.578Z'
                  updatedAt:
                    description: NOT IN MASTER DATA SPECIFICATION
                    type: string
                    format: datetime
                    example: '2020-09-11T11:56:41.578Z'
              example:
                id: b36d674f-b97c-4685-95f3-aacae8c97bde
                clientId: 1b1gshltt176v80nsc4fxxxxxx
                name: wrls
                status: active
                admin: 'false'
                createdAt: '2020-12-02T09:19:22.065Z'
                updatedAt: '2020-12-02T09:19:22.065Z'
                regimes:
                - id: 2f62bc92-7372-4d2a-979b-792e530c311c
                  slug: wrls
                  name: Water Resources
                  preSrocCutoffDate: '2020-04-01T00:00:00.000Z'
                  createdAt: '2020-12-01T09:19:22.065Z'
                  updatedAt: '2020-12-01T09:19:22.065Z'
  "/admin/health/airbrake":
    get:
      operationId: CheckAirbrake
      description: Used to confirm Airbrake is connected correctly to an environment
      tags:
      - admin
      responses:
        '500':
          description: An error has been thrown on purpose by the API. Check either
            the production or non-production instance of Errbit to confirm it received
            the error
  "/admin/health/database":
    get:
      operationId: CheckDatabase
      description: |-
        Used to check the API is correctly connected to the database in an environment. Will also provide some general stats about the data held
        > The endpoint does return a JSON response. However, it's pretty sizable and just a JSON version of [pg_stat_user_tables](http://www.postgresql.cn/docs/10/monitoring-stats.html#PG-STAT-ALL-TABLES-VIEW). So we don't document it here.
      tags:
      - admin
      responses:
        '200':
          description: Success
  "/v2/{regime}/bill-runs":
    post:
      operationId: CreateBillRun
      description: This endpoint triggers creation of a bill run record for a region.
        Bill run contains no transactions on creation.
      tags:
      - billrun
      parameters:
      - name: regime
        in: path
        required: true
        description: Charging regime to use
        schema:
          description: NOT IN MASTER DATA SPECIFICATION
          type: string
          enum:
          - cfd
          - pas
          - wml
          - wrls
          example: wrls
      responses:
        '201':
          description: Success
          content:
            application/json:
              schema:
                description: ''
                type: object
                properties:
                  billrun:
                    type: object
                    properties:
                      id:
                        description: Internal ID (GUID) allocated by the CM when creating
                          a bill run.
                        type: string
                        format: uuid
                        example: fd2ab097-3097-42bd-849e-046aa250a0d0
                      billRunNumber:
                        description: The five-digit bill run number of the file generated
                          by the CM in which the transaction was included
                        type: integer
                        minimum: 10000
                        maximum: 99999
                        example: 14283
              example:
                billRun:
                  id: 2bbbe459-966e-4026-b5d2-2f10867bdddd
                  billRunNumber: 10004
      requestBody:
        content:
          application/json:
            schema:
              description: ''
              type: object
              properties:
                region:
                  description: A single-digit region identifier for a transaction
                    or customer
                  type: string
                  enum:
                  - A
                  - B
                  - E
                  - N
                  - S
                  - T
                  - W
                  - Y
                  example: A
              required:
              - region
            example:
              region: A
  "/v2/{regime}/bill-runs/{billrunId}":
    get:
      operationId: ViewBillRun
      description: Request to view a single bill run based on the bill run ID.
      tags:
      - billrun
      parameters:
      - name: regime
        in: path
        required: true
        description: Charging regime to use
        schema:
          description: NOT IN MASTER DATA SPECIFICATION
          type: string
          enum:
          - cfd
          - pas
          - wml
          - wrls
          example: wrls
      - name: billrunId
        in: path
        required: true
        description: Internal ID (GUID) allocated by the CM when creating a bill run.
        schema:
          description: Internal ID (GUID) allocated by the CM when creating a bill
            run.
          type: string
          format: uuid
          example: fd2ab097-3097-42bd-849e-046aa250a0d0
      responses:
        '200':
          description: Success
          content:
            application/json:
              examples:
                01 Just created:
                  value:
                    billRun:
                      id: fd2ab097-3097-42bd-849e-046aa250a0d0
                      billRunNumber: 10001
                      region: W
                      status: initialised
                      approvedForBilling: false
                      preSroc: true
                      creditNoteCount: 0
                      creditNoteValue: 0
                      invoiceCount: 0
                      invoiceValue: 0
                      creditLineCount: 0
                      creditLineValue: 0
                      debitLineCount: 0
                      debitLineValue: 0
                      zeroValueLineCount: 0
                      netTotal: 0
                      invoices: []
                02 Transactions added:
                  value:
                    billRun:
                      id: fd2ab097-3097-42bd-849e-046aa250a0d0
                      billRunNumber: 10001
                      region: W
                      status: initialised
                      approvedForBilling: false
                      preSroc: true
                      creditNoteCount: 0
                      creditNoteValue: 0
                      invoiceCount: 0
                      invoiceValue: 0
                      creditLineCount: 0
                      creditLineValue: 0
                      debitLineCount: 2
                      debitLineValue: 2500
                      zeroValueLineCount: 0
                      netTotal: 2500
                      invoices:
                      - id: aa630ae0-0e51-4166-9025-66576c513f7f
                        summarised: false
                        customerReference: TH150000020
                        financialYear: 2019
                        creditLineCount: 0
                        creditLineValue: 0
                        debitLineCount: 2
                        debitLineValue: 2500
                        zeroValueLineCount: 0
                        netTotal: 2500
                        deminimis: false
                        netZeroValue: false
                        transactionType: ''
                        transactionReference: ''
                        licences:
                        - id: 3bde68ad-f55e-4a15-b1d8-c2fcd0a95fea
                          licenceNumber: FOOO/BARRR/306
                        - id: 77502697-e274-491a-bd6d-84ec557b0485
                          licenceNumber: FOOO/BARRR/307
                03 Generating summary:
                  value:
                    billRun:
                      id: fd2ab097-3097-42bd-849e-046aa250a0d0
                      billRunNumber: 10001
                      region: W
                      status: generating
                      approvedForBilling: false
                      preSroc: true
                      creditNoteCount: 0
                      creditNoteValue: 0
                      invoiceCount: 0
                      invoiceValue: 0
                      creditLineCount: 0
                      creditLineValue: 0
                      debitLineCount: 2
                      debitLineValue: 2500
                      zeroValueLineCount: 0
                      netTotal: 2500
                      invoices:
                      - id: aa630ae0-0e51-4166-9025-66576c513f7f
                        summarised: false
                        customerReference: TH150000020
                        financialYear: 2019
                        creditLineCount: 0
                        creditLineValue: 0
                        debitLineCount: 2
                        debitLineValue: 2500
                        zeroValueLineCount: 0
                        netTotal: 2500
                        deminimis: false
                        netZeroValue: false
                        transactionType: ''
                        transactionReference: ''
                        licences:
                        - id: 3bde68ad-f55e-4a15-b1d8-c2fcd0a95fea
                          licenceNumber: FOOO/BARRR/306
                        - id: 77502697-e274-491a-bd6d-84ec557b0485
                          licenceNumber: FOOO/BARRR/307
                04 Summary generated:
                  value:
                    billRun:
                      id: fd2ab097-3097-42bd-849e-046aa250a0d0
                      billRunNumber: 10001
                      region: W
                      status: summarised
                      approvedForBilling: false
                      preSroc: true
                      creditNoteCount: 0
                      creditNoteValue: 0
                      invoiceCount: 1
                      invoiceValue: 2500
                      creditLineCount: 0
                      creditLineValue: 0
                      debitLineCount: 2
                      debitLineValue: 2500
                      zeroValueLineCount: 0
                      netTotal: 2500
                      invoices:
                      - id: aa630ae0-0e51-4166-9025-66576c513f7f
                        summarised: true
                        customerReference: TH150000020
                        financialYear: 2019
                        creditLineCount: 0
                        creditLineValue: 0
                        debitLineCount: 2
                        debitLineValue: 2500
                        zeroValueLineCount: 0
                        netTotal: 2500
                        deminimis: false
                        netZeroValue: false
                        transactionType: ''
                        transactionReference: ''
                        licences:
                        - id: 3bde68ad-f55e-4a15-b1d8-c2fcd0a95fea
                          licenceNumber: FOOO/BARRR/306
                        - id: 77502697-e274-491a-bd6d-84ec557b0485
                          licenceNumber: FOOO/BARRR/307
  "/v2/{regime}/bill-runs/{billrunId}/status":
    get:
      operationId: ViewBillRunStatus
      description: Request to view the status of a single bill run based on the bill
        run ID. It is intended to help client systems quickly determine if a bill
        run is ready to be viewed after a `/generate` request and reduce the load
        on the API.
      tags:
      - billrun
      parameters:
      - name: regime
        in: path
        required: true
        description: Charging regime to use
        schema:
          description: NOT IN MASTER DATA SPECIFICATION
          type: string
          enum:
          - cfd
          - pas
          - wml
          - wrls
          example: wrls
      - name: billrunId
        in: path
        required: true
        description: Internal ID (GUID) allocated by the CM when creating a bill run.
        schema:
          description: Internal ID (GUID) allocated by the CM when creating a bill
            run.
          type: string
          format: uuid
          example: fd2ab097-3097-42bd-849e-046aa250a0d0
      responses:
        '200':
          description: Success
          content:
            application/json:
              examples:
                01 Just created:
                  value:
                    status: initialised
                02 Transactions added:
                  value:
                    status: initialised
                03 Generating summary:
                  value:
                    status: generating
                04 Summary generated:
                  value:
                    status: summarised
  "/v2/{regime}/bill-runs/{billrunId}/generate":
    patch:
      operationId: GenerateBillRun
      description: Generate the summary for the specified bill run. Bill run must
        be unbilled. Must take place before bill run is sent.
      tags:
      - billrun
      parameters:
      - name: regime
        in: path
        required: true
        description: Charging regime to use
        schema:
          description: NOT IN MASTER DATA SPECIFICATION
          type: string
          enum:
          - cfd
          - pas
          - wml
          - wrls
          example: wrls
      - name: billrunId
        in: path
        required: true
        description: Internal ID (GUID) allocated by the CM when creating a bill run.
        schema:
          description: Internal ID (GUID) allocated by the CM when creating a bill
            run.
          type: string
          format: uuid
          example: fd2ab097-3097-42bd-849e-046aa250a0d0
      responses:
        '204':
          description: Success
        '409':
          description: Conflict - status of the bill run means the summary cannot
            be generated. For example, the bill run is billed or the summary has already
            been generated.
  "/v2/{regime}/bill-runs/{billrunId}/send":
    patch:
      operationId: SendBillRun
      description: Triggers creation of a transaction file containing all transactions
        in the bill run. Bill run must be `approved` else the request will be rejected.
      tags:
      - billrun
      parameters:
      - name: regime
        in: path
        required: true
        description: Charging regime to use
        schema:
          description: NOT IN MASTER DATA SPECIFICATION
          type: string
          enum:
          - cfd
          - pas
          - wml
          - wrls
          example: wrls
      - name: billrunId
        in: path
        required: true
        description: Internal ID (GUID) allocated by the CM when creating a bill run.
        schema:
          description: Internal ID (GUID) allocated by the CM when creating a bill
            run.
          type: string
          format: uuid
          example: fd2ab097-3097-42bd-849e-046aa250a0d0
      responses:
        '204':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  billRun:
                    type: object
                    properties:
                      transactionFileReference:
                        description: NOT IN MASTER DATA SPECIFICATION
                        type: string
                        example: nalai50001.dat
                      transactionFileDate:
                        description: Estimated date of issue of the invoice.  In reality
                          this will be the date of generation of the transaction file,
                          and SSCL will over-write it with the actual invoice date
                          on receipt of the transaction file
                        type: string
                        nullable: true
                        example: 03-JUN-2020
        '409':
          description: Conflict - status of the bill run means the summary cannot
            be generated. For example, the bill run is not approved or is already
            billed.
  "/v2/{regime}/bill-runs/{billrunId}/transactions":
    post:
      operationId: AddBillRunTransaction
      description: Triggers creation of a transaction and immediately adds it to the
        specified bill run.
      tags:
      - billrun
      parameters:
      - name: regime
        in: path
        required: true
        description: Charging regime to use
        schema:
          description: NOT IN MASTER DATA SPECIFICATION
          type: string
          enum:
          - cfd
          - pas
          - wml
          - wrls
          example: wrls
      - name: billrunId
        in: path
        required: true
        description: Internal ID (GUID) allocated by the CM when creating a bill run.
        schema:
          description: Internal ID (GUID) allocated by the CM when creating a bill
            run.
          type: string
          format: uuid
          example: fd2ab097-3097-42bd-849e-046aa250a0d0
      responses:
        '201':
          description: Success
          content:
            application/json:
              schema:
                description: ''
                type: object
                properties:
                  transaction:
                    type: object
                    properties:
                      id:
                        description: Internal ID (GUID) allocated by the CM when creating
                          a transaction, not necessarily visible to the user
                        type: string
                        format: uuid
                        example: fd2ab097-3097-42bd-849e-046aa250a0d0
              example:
                transaction:
                  id: fd88e6c5-8da8-4e4f-b22f-c66554cd5bf3
      requestBody:
        content:
          application/json:
            schema:
              description: ''
              type: object
              properties:
                periodStart:
                  description: The start date of the charge period covered by a transaction
                  type: string
                  example: 01-APR-2018
                periodEnd:
                  description: The end date of the charge period covered by a transaction
                  type: string
                  example: 31-MAR-2019
                credit:
                  description: Boolean indicator to show whether the transaction is
                    a credit (negative value)
                  type: boolean
                  example: false
                billableDays:
                  description: The number of days covered by a charge
                  type: integer
                  minimum: 0
                  maximum: 366
                  example: 149
                authorisedDays:
                  description: The number of days per year in which abstraction is
                    authorised under the terms of the licence
                  type: integer
                  minimum: 0
                  maximum: 366
                  example: 214
                volume:
                  description: The volume (in thousands of cubic metres) on which
                    the charge is based
                  type: number
                  minimum: 0
                  example: 19.909
                source:
                  description: Source on which standard charge calculation based
                  type: string
                  enum:
                  - Supported
                  - Kielder
                  - Unsupported
                  - Tidal
                  example: Unsupported
                season:
                  description: Season on which charge calculation based
                  type: string
                  enum:
                  - Summer
                  - Winter
                  - All Year
                  example: Summer
                loss:
                  description: Loss on which charge calculation based
                  type: string
                  enum:
                  - High
                  - Medium
                  - Low
                  - Very Low
                  example: Medium
                twoPartTariff:
                  description: Boolean indicator to show whether the transaction is
                    for the second part of a 2-part tariff charge
                  type: boolean
                  example: true
                compensationCharge:
                  description: Boolean indicator to show whether the transaction relates
                    to a compensation charge
                  type: boolean
                  example: false
                eiucSource:
                  description: Source on which compensation charge calculation based.
                    This field is required when creating a transacton if `compensationCharge`
                    is set to `true`
                  type: string
                  example: Tidal
                waterUndertaker:
                  description: Boolean indicator to show whether the transaction is
                    for a water undertaker
                  type: boolean
                  example: false
                regionalChargingArea:
                  description: The name of the region relevant to the determination
                    of the SUC and / or EIUC value to be used in the calculation
                  type: string
                  enum:
                  - Anglian
                  - Midlands
                  - South West
                  - North West
                  - Southern
                  - Thames
                  - Northumbria
                  - Yorkshire
                  - Wales
                  example: Northumbria
                section127Agreement:
                  description: Indicator to show whether a section 127 charge agreement
                    applies to the transaction
                  type: boolean
                  example: false
                section130Agreement:
                  description: Indicator to show whether a section 130 charge agreement
                    applies to the transaction
                  type: boolean
                  example: true
                customerReference:
                  description: Customer Number of the invoicee
                  type: string
                  example: B19120000A
                lineDescription:
                  description: Description of the reason for the charge, to appear
                    on the invoice sent to the customer
                  type: string
                  maxLength: 240
                  example: Borehole at Runhall, Norfolk.
                licenceNumber:
                  description: The reference of the licence to which a charge / transaction
                    relates
                  type: string
                  maxLength: 150
                  example: 7/34/16/*G/0093
                chargePeriod:
                  description: The charge period for a transaction (i.e. charge period
                    start date to charge period end date)
                  type: string
                  example: 01-APR-2018 - 31-MAR-2019
                chargeElementId:
                  description: An indicator (normally an integer) to distinguish between
                    the different charge elements on a specific licence.
                  type: string
                  nullable: true
                  example: '1'
                batchNumber:
                  description: Number to be generated by WRLS indicating the 'batch'
                    in which creation of a transaction was requested
                  type: string
                  nullable: true
                  example: TONY100
                region:
                  description: A single-digit region identifier for a transaction
                    or customer
                  type: string
                  enum:
                  - A
                  - B
                  - E
                  - N
                  - S
                  - T
                  - W
                  - Y
                  example: A
                areaCode:
                  description: Code identifying the historic area (within a region)
                    for the transaction.
                  type: string
                  enum:
                  - ARCA
                  - AREA
                  - ARNA
                  - CASC
                  - MIDLS
                  - MIDLT
                  - MIDUS
                  - MIDUT
                  - AACOR
                  - AADEV
                  - AANWX
                  - AASWX
                  - NWCEN
                  - NWNTH
                  - NWSTH
                  - HAAR
                  - KAEA
                  - SAAR
                  - AGY2N
                  - AGY2S
                  - AGY3
                  - AGY3N
                  - AGY3S
                  - AGY4N
                  - AGY4S
                  - N
                  - SE
                  - SE1
                  - SE2
                  - SW
                  - ABNRTH
                  - DALES
                  - NAREA
                  - RIDIN
                  - DEFAULT
                  - MULTI
                  example: NWCEN
                newLicence:
                  description: Boolean indicator to show whether a transaction has
                    arisen as the result of a new licence being created (note that
                    'new' may also incorporate licence renewals or transfers of a
                    licence to a new customer)
                  type: boolean
                  example: false
                clientId:
                  description: ID of the transaction in the client system. If provided
                    at the time of creation the API will first check no existing transactions
                    with the same ID for that regime exist.
                  type: string
                  nullable: true
                  example: hb3ab097-8567-42bd-849e-046aa250a8u8
              required:
              - region
              - periodStart
              - periodEnd
              - customerReference
              - licenceNumber
              - billableDays
              - authorisedDays
              - volume
              - source
              - season
              - loss
              - section130Agreement
              - section127Agreement
              - twoPartTariff
              - compensationCharge
              - regionalChargingArea
              - credit
              - areaCode
              - lineDescription
              - waterUndertaker
              - chargePeriod
            example:
              periodStart: 01-APR-2019
              periodEnd: 31-MAR-2020
              credit: false
              billableDays: 310
              authorisedDays: 365
              volume: '6.22'
              source: Supported
              season: Summer
              loss: Low
              twoPartTariff: false
              compensationCharge: false
              eiucSource: Tidal
              waterUndertaker: false
              regionalChargingArea: Anglian
              section127Agreement: false
              section130Agreement: false
              customerReference: TH230000222
              lineDescription: Well at Chigley Town Hall
              licenceNumber: TONY/TF9222/37
              chargePeriod: 01-APR-2018 - 31-MAR-2019
              chargeElementId: ''
              batchNumber: TONY10
              region: W
              areaCode: ARCA
  "/v2/{regime}/calculate-charge":
    post:
      operationId: CalculateCharge
      description: Request to calculate a standalone charge based on a set of charge
        parameters, without creating a transaction. Input and output data is not retained
        in the CM.
      tags:
      - calculate
      parameters:
      - name: regime
        in: path
        required: true
        description: Charging regime to use
        schema:
          description: NOT IN MASTER DATA SPECIFICATION
          type: string
          enum:
          - cfd
          - pas
          - wml
          - wrls
          example: wrls
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  calculation:
                    description: ''
                    type: object
                    properties:
                      chargeValue:
                        description: The value of the transaction in pounds and pence,
                          as calculated by the rules service
                        type: number
                        example: 929
                      sourceFactor:
                        description: The source factor applied to the calculation
                        type: number
                        example: 9
                      seasonFactor:
                        description: The season factor applied to the calculation
                        type: number
                        example: 0.16
                      lossFactor:
                        description: The loss factor applied to the calculation
                        type: number
                        example: 0.003
                      licenceHolderChargeAgreement:
                        description: Summary of the Section 130 charge calculation
                          in a specific format required by the transaction file
                        type: string
                        nullable: true
                        example: S130U x 0.5
                      chargeElementAgreement:
                        description: Summary of the Section 126 or Section 127 charge
                          calculations in a specific format required by the transaction
                          file
                        type: string
                        nullable: true
                        example: S126 x 0.8
                      eiucSourceFactor:
                        description: The EIUC adjusted source factor applied to the
                          calculation
                        type: number
                        example: 0.2
                      eiuc:
                        description: Environmental Improvement Unit Charge (EIUC)
                          for the transaction
                        type: number
                        example: 0.2
                      suc:
                        description: Standard Unit Charge (SUC) for the transaction
                        type: number
                        example: 27.51
              example:
                calculation:
                  chargeValue: 772
                  sourceFactor: 3
                  seasonFactor: 1.6
                  lossFactor: 0.03
                  licenceHolderChargeAgreement:
                  chargeElementAgreement:
                  eiucSourceFactor: 0
                  eiuc: 0
                  suc: 1495
      requestBody:
        content:
          application/json:
            schema:
              description: ''
              type: object
              properties:
                periodStart:
                  description: The start date of the charge period covered by a transaction
                  type: string
                  example: 01-APR-2018
                periodEnd:
                  description: The end date of the charge period covered by a transaction
                  type: string
                  example: 31-MAR-2019
                credit:
                  description: Boolean indicator to show whether the transaction is
                    a credit (negative value)
                  type: boolean
                  example: false
                billableDays:
                  description: The number of days covered by a charge
                  type: integer
                  minimum: 0
                  maximum: 366
                  example: 149
                authorisedDays:
                  description: The number of days per year in which abstraction is
                    authorised under the terms of the licence
                  type: integer
                  minimum: 0
                  maximum: 366
                  example: 214
                volume:
                  description: The volume (in thousands of cubic metres) on which
                    the charge is based
                  type: number
                  minimum: 0
                  example: 19.909
                source:
                  description: Source on which standard charge calculation based
                  type: string
                  enum:
                  - Supported
                  - Kielder
                  - Unsupported
                  - Tidal
                  example: Unsupported
                season:
                  description: Season on which charge calculation based
                  type: string
                  enum:
                  - Summer
                  - Winter
                  - All Year
                  example: Summer
                loss:
                  description: Loss on which charge calculation based
                  type: string
                  enum:
                  - High
                  - Medium
                  - Low
                  - Very Low
                  example: Medium
                twoPartTariff:
                  description: Boolean indicator to show whether the transaction is
                    for the second part of a 2-part tariff charge
                  type: boolean
                  example: true
                compensationCharge:
                  description: Boolean indicator to show whether the transaction relates
                    to a compensation charge
                  type: boolean
                  example: false
                eiucSource:
                  description: Source on which compensation charge calculation based
                  type: string
                  example: Tidal
                waterUndertaker:
                  description: Boolean indicator to show whether the transaction is
                    for a water undertaker
                  type: boolean
                  example: false
                regionalChargingArea:
                  description: The name of the region relevant to the determination
                    of the SUC and / or EIUC value to be used in the calculation
                  type: string
                  enum:
                  - Anglian
                  - Midlands
                  - South West
                  - North West
                  - Southern
                  - Thames
                  - Northumbria
                  - Yorkshire
                  - Wales
                  example: Northumbria
                section126Factor:
                  description: The factor to apply to the charge where a section 126
                    charge agreement is relevant to the transaction
                  type: number
                  minimum: 0
                  maximum: 1
                  example: 0.75
                section127Agreement:
                  description: Indicator to show whether a section 127 charge agreement
                    applies to the transaction
                  type: boolean
                  example: false
                section130Agreement:
                  description: Indicator to show whether a section 130 charge agreement
                    applies to the transaction
                  type: boolean
                  example: true
              required:
              - periodStart
              - periodEnd
              - billableDays
              - authorisedDays
              - volume
              - source
              - season
              - loss
              - section130Agreement
              - section127Agreement
              - twoPartTariff
              - compensationCharge
              - regionalChargingArea
              - credit
              - waterUndertaker
            example:
              periodStart: 01-APR-2020
              periodEnd: 31-MAR-2021
              credit: false
              billableDays: 214
              authorisedDays: 214
              volume: '3.5865'
              source: Supported
              season: Summer
              loss: Low
              twoPartTariff: false
              compensationCharge: false
              eiucSource: Tidal
              waterUndertaker: false
              regionalChargingArea: Midlands
              section126Factor: 1
              section127Agreement: false
              section130Agreement: false
  "/v2/{regime}/invoices/{invoiceId}":
    get:
      operationId: ViewInvoice
      description: Request to view details of an invoice.
      tags:
      - suggested
      parameters:
      - name: regime
        in: path
        required: true
        description: Charging regime to use
        schema:
          description: NOT IN MASTER DATA SPECIFICATION
          type: string
          enum:
          - cfd
          - pas
          - wml
          - wrls
          example: wrls
      - name: invoiceId
        in: path
        required: true
        description: Internal ID (GUID) allocated by the CM when creating an invoice.
        schema:
          description: Internal ID (GUID) allocated by the CM when creating an invoice.
          type: string
          format: uuid
          example: fd2ab097-3097-42bd-849e-046aa250a0d0
      responses:
        '200':
          description: Success
          content:
            application/json:
              example:
                invoice:
                  id: fd88e6c5-8da8-4e4f-b22f-c66554cd5bf3
                  billRunId: fd2ab097-3097-42bd-849e-046aa250a0d0
                  summarised: true
                  customerReference: TH230000222
                  financialYear: 2018
                  creditLineCount: 0
                  creditLineValue: 0
                  debitLineCount: 2
                  debitLineValue: 4186
                  zeroValueLineCount: 1
                  newLicenceCount: 0
                  netTotal: 4186
                  deminimis: false
                  netZeroValue: false
                  transactionType: ''
                  transactionReference: ''
                  licences:
                  - id: 559943dd-8d08-4c95-9600-9c6c7d08d0d8
                    creditLineCount: 0
                    creditLineValue: 0
                    debitLineCount: 2
                    debitLineValue: 4186
                    zeroValueLineCount: 0
                    newLicenceCount: 0
                    netTotal: 4186
                  - id: b297f240-7a32-444c-a2c4-add07869760f
                    creditLineCount: 0
                    creditLineValue: 0
                    debitLineCount: 0
                    debitLineValue: 0
                    zeroValueLineCount: 1
                    newLicenceCount: 0
                    netTotal: 0
    delete:
      operationId: DeleteInvoice
      description: Delete the specified invoice and all linked licences and transactions.
        As part of the deletion the linked bill run will be updated.
      tags:
      - suggested
      parameters:
      - name: regime
        in: path
        required: true
        description: Charging regime to use
        schema:
          description: NOT IN MASTER DATA SPECIFICATION
          type: string
          enum:
          - cfd
          - pas
          - wml
          - wrls
          example: wrls
      - name: invoiceId
        in: path
        required: true
        description: Internal ID (GUID) allocated by the CM when creating an invoice.
        schema:
          description: Internal ID (GUID) allocated by the CM when creating an invoice.
          type: string
          format: uuid
          example: fd2ab097-3097-42bd-849e-046aa250a0d0
      responses:
        '204':
          description: Success
  "/v2/{regime}/licences/{licenceId}":
    get:
      operationId: ViewLicence
      description: Request to view details of a licence.
      tags:
      - suggested
      parameters:
      - name: regime
        in: path
        required: true
        description: Charging regime to use
        schema:
          description: NOT IN MASTER DATA SPECIFICATION
          type: string
          enum:
          - cfd
          - pas
          - wml
          - wrls
          example: wrls
      - name: licenceId
        in: path
        required: true
        description: Internal ID (GUID) allocated by the CM when creating a licence.
        schema:
          description: Internal ID (GUID) allocated by the CM when creating a licence.
          type: string
          format: uuid
          example: fd2ab097-3097-42bd-849e-046aa250a0d0
      responses:
        '200':
          description: Success
          content:
            application/json:
              example:
                licence:
                  id: fd88e6c5-8da8-4e4f-b22f-c66554cd5bf3
                  billRunId: fd2ab097-3097-42bd-849e-046aa250a0d0
                  invoiceId: 559943dd-8d08-4c95-9600-9c6c7d08d0d8
                  licenceNumber: FOOO/BARRR/306
                  creditLineCount: 0
                  creditLineValue: 0
                  debitLineCount: 2
                  debitLineValue: 4186
                  zeroValueLineCount: 1
                  newLicenceCount: 3
                  netTotal: 4186
                  transactions:
                  - id: fe36eccb-4d58-4cb0-8062-01f7c2b886c2
                    region: A
                    credit: false
                    chargeValue: 2093
                  - id: '08a74e38-3652-44b9-8459-c364d3a3e524'
                    region: A
                    credit: false
                    chargeValue: 2093
                  - id: 9b1cc7c7-4b19-42cc-8d17-90f121edebbb
                    region: A
                    credit: false
                    chargeValue: 0
    delete:
      operationId: DeleteLicence
      description: Delete the specified licence and all linked transactions. As part
        of the deletion the linked invoice and bill run will also be updated.
      tags:
      - suggested
      parameters:
      - name: regime
        in: path
        required: true
        description: Charging regime to use
        schema:
          description: NOT IN MASTER DATA SPECIFICATION
          type: string
          enum:
          - cfd
          - pas
          - wml
          - wrls
          example: wrls
      - name: licenceId
        in: path
        required: true
        description: Internal ID (GUID) allocated by the CM when creating a licence.
        schema:
          description: Internal ID (GUID) allocated by the CM when creating a licence.
          type: string
          format: uuid
          example: fd2ab097-3097-42bd-849e-046aa250a0d0
      responses:
        '204':
          description: Success
security:
- OAuth2: []
components:
  securitySchemes:
    OAuth2:
      type: oauth2
      description: The API uses [AWS Cognito](https://docs.aws.amazon.com/cognito/latest/developerguide/what-is-amazon-cognito.html)
        to manage authentication and authorisation. To use it you will first need
        a cognito client ID and password. You then use these to request a bearer token
        from AWS Cognito. The bearer token is then sent in the `Authorisation` header
        of your request
      flows:
        clientCredentials:
          tokenUrl: https://chargingmoduleapi.auth.eu-west-1.amazoncognito.com/oauth2/token
          scopes: {}
